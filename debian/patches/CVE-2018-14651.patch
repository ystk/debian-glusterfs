From: Markus Koschany <apo@debian.org>
Date: Sat, 3 Nov 2018 16:38:23 +0100
Subject: CVE-2018-14651

Origin: http://git.gluster.org/cgit/glusterfs.git/commit/?id=5fdb7ae37f602894f81a2cadc5a4c609a4c85427
---
 xlators/protocol/server/src/server-resolve.c | 25 +++++++++++++++++++------
 xlators/storage/posix/src/posix-handle.h     |  4 ++--
 2 files changed, 21 insertions(+), 8 deletions(-)

diff --git a/xlators/protocol/server/src/server-resolve.c b/xlators/protocol/server/src/server-resolve.c
index 57db5ed..c9f56cd 100644
--- a/xlators/protocol/server/src/server-resolve.c
+++ b/xlators/protocol/server/src/server-resolve.c
@@ -251,12 +251,8 @@ resolve_entry_simple (call_frame_t *frame)
                 goto out;
         }
 
-        /* expected @parent was found from the inode cache */
-        uuid_copy (state->loc_now->pargfid, resolve->pargfid);
-        state->loc_now->parent = inode_ref (parent);
-
-        if (strstr (resolve->bname, "../")) {
-                /* Resolving outside the parent's tree is not allowed */
+    if (parent->ia_type != IA_IFDIR) {
+        /* Parent type should be 'directory', and nothing else */
                 gf_log (this->name, GF_LOG_ERROR,
                         "%s: path sent by client not allowed",
                         resolve->bname);
@@ -265,6 +261,23 @@ resolve_entry_simple (call_frame_t *frame)
                 ret = 1;
                 goto out;
         }
+
+    /* expected @parent was found from the inode cache */
+    uuid_copy (state->loc_now->pargfid, resolve->pargfid);
+    state->loc_now->parent = inode_ref (parent);
+    if (strchr(resolve->bname, '/')) {
+        /* basename should be a string (without '/') in a directory,
+           it can't span multiple levels. This can also lead to
+           resolving outside the parent's tree, which is not allowed */
+        gf_log (this->name, GF_LOG_ERROR,
+               "%s: basename sent by client not allowed",
+                resolve->bname);
+        resolve->op_ret = -1;
+        resolve->op_errno = EPERM;
+        ret = 1;
+        goto out;
+    }
+
         state->loc_now->name = resolve->bname;
 
         inode = inode_grep (state->itable, parent, resolve->bname);
diff --git a/xlators/storage/posix/src/posix-handle.h b/xlators/storage/posix/src/posix-handle.h
index 87e54cc..dc29542 100644
--- a/xlators/storage/posix/src/posix-handle.h
+++ b/xlators/storage/posix/src/posix-handle.h
@@ -177,9 +177,9 @@
                 break;                                                  \
         }                                                               \
                                                                         \
-        if (strstr (loc->name, "../")) {                                \
+        if (strstr (loc->name, "/")) {                                  \
                 gf_log (this->name, GF_LOG_ERROR, \
-                        "'../' in name not allowed: (%s)", loc->name); \
+                        "'/' in name not allowed: (%s)", loc->name); \
                 op_ret = -1;                                            \
                 break;                                                  \
         }                                                               \
