From: Markus Koschany <apo@debian.org>
Date: Wed, 19 Sep 2018 19:23:07 +0200
Subject: CVE-2018-10926

This is also the fix for CVE-2018-10927, CVE-2018-10928, CVE-2018-10929
and CVE-2018-10930.

Origin: https://review.gluster.org/21068
---
 xlators/protocol/server/src/server-resolve.c | 11 +++++++++++
 xlators/storage/posix/src/posix-handle.h     |  6 ++++++
 2 files changed, 17 insertions(+)

diff --git a/xlators/protocol/server/src/server-resolve.c b/xlators/protocol/server/src/server-resolve.c
index 12eda6b..57db5ed 100644
--- a/xlators/protocol/server/src/server-resolve.c
+++ b/xlators/protocol/server/src/server-resolve.c
@@ -254,6 +254,17 @@ resolve_entry_simple (call_frame_t *frame)
         /* expected @parent was found from the inode cache */
         uuid_copy (state->loc_now->pargfid, resolve->pargfid);
         state->loc_now->parent = inode_ref (parent);
+
+        if (strstr (resolve->bname, "../")) {
+                /* Resolving outside the parent's tree is not allowed */
+                gf_log (this->name, GF_LOG_ERROR,
+                        "%s: path sent by client not allowed",
+                        resolve->bname);
+                resolve->op_ret   = -1;
+                resolve->op_errno = EPERM;
+                ret = 1;
+                goto out;
+        }
         state->loc_now->name = resolve->bname;
 
         inode = inode_grep (state->itable, parent, resolve->bname);
diff --git a/xlators/storage/posix/src/posix-handle.h b/xlators/storage/posix/src/posix-handle.h
index 38da908..87e54cc 100644
--- a/xlators/storage/posix/src/posix-handle.h
+++ b/xlators/storage/posix/src/posix-handle.h
@@ -177,6 +177,12 @@
                 break;                                                  \
         }                                                               \
                                                                         \
+        if (strstr (loc->name, "../")) {                                \
+                gf_log (this->name, GF_LOG_ERROR, \
+                        "'../' in name not allowed: (%s)", loc->name); \
+                op_ret = -1;                                            \
+                break;                                                  \
+        }                                                               \
         if (LOC_HAS_ABSPATH (loc)) {                                    \
                 MAKE_REAL_PATH (entp, this, loc->path);                 \
                 __parp = strdupa (entp);                                \
