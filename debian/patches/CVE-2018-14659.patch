From: Markus Koschany <apo@debian.org>
Date: Sat, 3 Nov 2018 22:05:19 +0100
Subject: CVE-2018-14659

Origin: http://git.gluster.org/cgit/glusterfs.git/commit/?id=be1e1785e2e4f3d6345ea5b5b684a1429784a01c
---
 libglusterfs/src/common-utils.h       | 3 +++
 xlators/debug/io-stats/src/io-stats.c | 8 ++++++++
 2 files changed, 11 insertions(+)

diff --git a/libglusterfs/src/common-utils.h b/libglusterfs/src/common-utils.h
index 28b2836..f779788 100644
--- a/libglusterfs/src/common-utils.h
+++ b/libglusterfs/src/common-utils.h
@@ -78,6 +78,9 @@ void trap (void);
          !strcmp (fs_name, "ext3") || \
          !strcmp (fs_name, "ext4"))
 
+#define GF_SERVER_PROCESS 0
+#define GF_CLIENT_PROCESS 1
+#define GF_GLUSTERD_PROCESS 2
 /* Defining this here as it is needed by glusterd for setting
  * nfs port in volume status.
  */
diff --git a/xlators/debug/io-stats/src/io-stats.c b/xlators/debug/io-stats/src/io-stats.c
index 0213c1c..7df80d1 100644
--- a/xlators/debug/io-stats/src/io-stats.c
+++ b/xlators/debug/io-stats/src/io-stats.c
@@ -2192,6 +2192,14 @@ conditional_dump (dict_t *dict, char *key, data_t *value, void *data)
 
         stub  = data;
         this  = stub->this;
+        /* Don't do this on 'brick-side', only do this on client side */
+        /* Addresses CVE-2018-14659 */
+        if (this->ctx->process_mode != GF_CLIENT_PROCESS) {
+            gf_log(this->name, GF_LOG_DEBUG,
+                "taking io-stats dump using setxattr not permitted on brick."
+                " Use 'gluster profile' instead");
+            return -1;
+        }
 
         path_in_value = data_to_str (value);
 
